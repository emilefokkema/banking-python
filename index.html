<html>
	<head>
		<title>Process my banking statements</title>
		<!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<script src="index.js"></script>
		
		<link rel="stylesheet" type="text/css" href="index.css">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
	</head>
	<body>

		<script type="text/template" id="categoryTemplate">
			<div class="category" v-bind:class="{collapsed:collapsed,'category-top':top}">
				<div class="category-header">
					<span v-bind:class="{'toggle-collapse':!isSimple}" v-on:click="toggleCollapse">
						<span class="neither category-header-prefix" v-if="isSimple"></span>
						<template v-else>
							<span class="plus category-header-prefix"><span class="fas fa-plus-square"></span></span>
							<span class="minus category-header-prefix"><span class="fas fa-minus-square"></span></span>
						</template>
						{{categoryData.name}}<expectation v-if="categoryData.expectation" v-bind:expectation="categoryData.expectation"></expectation>: <amount v-bind:numberOfCents="categoryData.total"></amount>
					</span>
				</div>
				<div class="category-set" v-if="categoryData.categories">
					<category v-for="category in categoryData.categories" v-bind:categoryData="category" v-bind:top="false"></category>
				</div>
				<row-collection v-if="categoryData.rows" v-bind:data="categoryData.rows"></row-collection>
			</div>
		</script>
		<script type="text/template" id="removeButtonTemplate">
			<span class="fas fa-times remove-button" v-on:click="click"></span>
		</script>
		<script type="text/template" id="rowCollectionTemplate">
			<div class="category-set">
				<row v-for="row in data.items" v-bind:row="row"></row>
				<span class="more" v-if="data.more">(en nog {{data.more}})</span>
			</div>
		</script>
		<script type="text/template" id="periodItemTemplate">
			<div class="panel period-list-item" v-bind:class="{'removing':isRemoving,'with-end':data.hasEnd, 'with-beginning':data.hasBeginning, 'collapsed':collapsed}">
				<div class="panel-header"><span class="panel-title" v-on:click="toggleCollapse">{{periodDescription}}</span> <remove-button v-if="data.hasEnd" v-on:click="remove"></remove-button></div>
				<div class="panel-body">
					<category v-bind:top="true" v-bind:categoryData="data.Bij"></category>
					<category v-bind:top="true" v-bind:categoryData="data.Af"></category>
				</div>
			</div>
		</script>
		<script type="text/template" id="expectationTemplate">
			<span class="expectation" v-bind:title="dateSummary"> ({{expectation.actual}})</span>
		</script>
		<script type="text/template" id="rowTemplate">
			<div class="row">
				<date v-bind:date="dateProperty.value" v-if="dateProperty" class="row-part"></date>
				<div class="row-part">
					<div class="string-property" v-for="prop in stringProperties"><span class="string-property-name" v-if="stringProperties.length > 1">{{prop.name}}:&nbsp;</span>{{prop.value}}</div>
				</div>
				<amount v-bind:numberOfCents="amountProperty.value" v-if="amountProperty" class="row-part"></amount>
			</div>
		</script>
		<script type="text/template" id="settingsTemplate">
			<div class="panel" v-bind:class="{'collapsed':collapsed}">
				<div class="panel-header"><span class="fas fa-cog panel-title" v-on:click="toggleCollapse"></span></div>
				<div class="panel-body">
					<div class="column-slots">
						<column-slot v-for="slot in slots" v-bind:data="slot" v-on:definitioncreated="onDefinitionCreated" v-on:definitionremoved="onDefinitionRemoved" v-on:selected="onSlotSelected" v-on:deselected="onSlotDeselected" v-on:change="onChanged"></column-slot>
						<span class="fas fa-plus add-button" v-on:click="addNewSlot"></span>
						<span class="fas fa-exchange-alt slot-switch-button" v-on:click="doSlotSwitch" v-if="canSwitch"></span>
					</div>
				</div>
				<div class="panel-body" v-if="data && data.categories">
					<category-settings ref="incoming" v-bind:property-list="data.rowDefinition.additional" v-bind:top="true" v-bind:data="incoming" v-on:changed="onChanged" v-on:propertyusechange="determineProtection" v-on:valid="onValid"></category-settings>
					<category-settings ref="outgoing" v-bind:property-list="data.rowDefinition.additional" v-bind:top="true" v-bind:data="outgoing" v-on:changed="onChanged" v-on:propertyusechange="determineProtection" v-on:valid="onValid"></category-settings>
				</div>
				<div class="panel-footer">
					<span class="fas fa-undo-alt reset-button" v-on:click="getSettings" v-if="dirty && saved"></span><span class="fas fa-save save-button" v-on:click="save" v-if="dirty && violationCount == 0"></span>
				</div>
			</div>
		</script>
		<script type="text/template" id="columnSlotTemplate">
			<div class="column-slot" v-on:click="onClick" v-bind:class="{'selected':data.selected}">
				<div class="slot-index">#{{index + 1}}</div>
				<template v-if="data.type == 'date'">
					<span class="fas fa-calendar-alt"></span><input class="input" v-model="data.definition.pattern" v-on:input="onChange"/>
				</template>
				<template v-if="data.type == 'direction'">
					<div>
						<span class="fas fa-plus"></span><input class="input" v-model="data.definition.incoming" v-on:input="onChange"/>
					</div>
					<div>
						<span class="fas fa-minus"></span><input class="input" v-model="data.definition.outgoing" v-on:input="onChange"/>
					</div>
				</template>
				<span v-if="data.type == 'string'"><input class="input" v-model="data.definition.name" placeholder="?" v-bind:disabled="protected" v-on:input="onChange"/></span>
				<span class="fas fa-dollar-sign" v-if="data.type == 'amount'"></span>
			</div>
		</script>
		<script type="text/template" id="categorySettingsTemplate">
			<div class="category" v-bind:class="{collapsed:collapsed,'category-top':top, 'non-existent':nonExistent}">
				<div class="category-header category-settings-header">
					<span class="toggle-collapse" v-on:click="toggleCollapse">
						<span class="plus category-header-prefix">
							<span class="fas fa-plus-square"></span>
						</span>
						<span class="minus category-header-prefix">
							<span class="fas fa-minus-square"></span>
						</span>
					</span>
					<input class="input" v-model="data.category.name" v-on:input="changed" placeholder="?"/>
				</div>
				<div class="category-set" v-if="data.exists">
					<div class="category-addon" v-if="!top" v-bind:class="{'active':filterActive}">
						<span class="fas fa-filter filter-button" v-on:click="toggleFilter"></span>
						<property-contains v-on:change="changed" v-on:propertyusechange="onPropertyUseChange" v-on:switch="onSwitch" v-if="data.category.acceptRow && data.category.acceptRow.propertyContains" v-bind:data="data.category.acceptRow.propertyContains" v-bind:property-list="propertyList"></property-contains>
						<property-matches v-on:change="changed" v-on:propertyusechange="onPropertyUseChange" v-on:valid="onValid" v-on:switch="onSwitch" v-if="data.category.acceptRow && data.category.acceptRow.propertyMatches" v-bind:data="data.category.acceptRow.propertyMatches" v-bind:property-list="propertyList"></property-matches>
					</div>
					<div class="category-addon" v-if="!top" v-bind:class="{'active':collectionActive}">
						<span class="fas fa-list-ul filter-button" v-on:click="toggleCollection"></span>
						<row-collection v-if="data.category.rowCollection" v-bind:data="data.category.rowCollection" v-bind:property-list="propertyList" v-on:propertyusechange="onPropertyUseChange" v-on:change="changed"></row-collection>
					</div>
					<category-settings v-on:categoryremoved="removeCategory" v-on:categorycreated="addNewCategory" v-bind:property-list="propertyList" v-for="slot in categorySlots" v-bind:data="slot" v-on:changed="changed" v-on:propertyusechange="onPropertyUseChange" v-on:valid="onValid" :key="slot.key"></category-settings>
				</div>

			</div>
		</script>
		<script type="text/template" id="rowCollectionSettingsTemplate">
			<div class="row-collection">
				<row-property v-for="property in data.properties" v-bind:data="property" v-bind:property-list="propertyList" v-on:propertyusechange="$emit('propertyusechange')" v-on:change="$emit('change')"></row-property>
			</div>
		</script>
		<script type="text/template" id="rowPropertyTemplate">
			<div class="row-property">
				<div class="source-type row-property-part">
					<source-property-input v-model="data.source" v-bind:property-list="propertyList"></source-property-input>
				</div>
				<div class="arrow-container row-property-part" v-if="hasStringSource">
					<span class="fas fa-arrow-right"></span>
				</div>
				<div class="row-property-part target-type" v-if="hasStringSource">
					<target-type-input v-model="targetType"></target-type-input>
					<input v-if="targetType === 'string'" class="input" v-model="data.name" v-on:input="$emit('change')"/>
					<div class="string-match" v-if="targetType === 'string'">
						<span class="fas fa-search"></span>
						<regex-input v-model="stringMatch" v-on:input="$emit('change')"></regex-input>
					</div>
					<input class="input" v-model="data.conversion.pattern" v-if="targetType === 'date'" v-on:input="$emit('change')"/>
				</div>
			</div>
		</script>
		<script type="text/template" id="sourcePropertyInputTemplate">
			<div class="input html-select">
				<div class="html-option-list">
					<div class="html-option" v-if="property == 'date' || expanded" v-on:click="select('date')"><span class="fas fa-calendar-alt"></span></div>
					<div class="html-option" v-for="prop of displayPropertyList" v-on:click="select(prop.name)">{{prop.name}}</div>
					<div class="html-option" v-if="property == 'amount' || expanded" v-on:click="select('amount')"><span class="fas fa-dollar-sign"></span></div>
				</div>
				<div class="html-option-expand" v-on:click="expanded = true"><span class="fas fa-caret-down"></span></div>
			</div>
		</script>
		<script type="text/template" id="targetTypeInputTemplate">
			<div class="input html-select">
				<div class="html-option-list">
					<div class="html-option" v-if="type == 'date' || expanded" v-on:click="select('date')"><span class="fas fa-calendar-alt"></span></div>
					<div class="html-option" v-if="type == 'string' || expanded" v-on:click="select('string')"><span class="fas fa-quote-left"></span><span class="fas fa-quote-right"></span></div>
				</div>
				<div class="html-option-expand" v-on:click="expanded = true"><span class="fas fa-caret-down"></span></div>
			</div>
		</script>
		<script type="text/template" id="propertyContainsTemplate">
			<div class="property-contains">
				<div>
					<select v-model="data.name" class="input" v-on:change="$emit('propertyusechange')">
						<option v-for="prop of propertyList" v-bind:value="prop.name">{{prop.name}}</option>
					</select>
					<select v-model="chosenVerb" class="input">
						<option v-bind:value="verb" v-for="verb of verbs">{{verb}}</option>
					</select>
				</div>
				<div class="input value-list-input">
					<div class="value-list-value" v-for="value in data.values">{{value}}</div>
					<input v-model="newValue" v-on:blur="addNewValue" v-on:keydown="onKeyDown"/>
				</div>
			</div>
		</script>
		<script type="text/template" id="propertyMatchesTemplate">
			<div class="property-matches">
				<div>
					<select v-model="data.name" class="input" v-on:change="$emit('propertyusechange')">
						<option v-for="prop of propertyList" v-bind:value="prop.name">{{prop.name}}</option>
					</select>
					<select v-model="chosenVerb" class="input">
						<option v-bind:value="verb" v-for="verb of verbs">{{verb}}</option>
					</select>
				</div>
				<regex-input v-model="data.pattern" v-on:valid="onValid" v-on:input="$emit('change')"></regex-input>
			</div>
		</script>
		<script type="text/template" id="regexInputTemplate">
			<input v-model="inputValue" class="input pattern-input" v-bind:class="{invalid:!valid}"/>
		</script>
		<div id="app">
			<settings v-on:settingsdirty="setSettingsDirty" v-on:settingsclean="setSettingsClean" v-on:error="displayError"></settings>
			<div>
				<div class="empty panel" v-if="completePeriods.length == 0">(no history)</div>
				<period-item v-for="period in completePeriods" v-bind:data="period.file" v-bind:file-name="period.fileName" v-on:removal="refreshComplete" v-on:error="displayError" :key="period.fileName"></period-item>
			</div>
			<div>
				<period-item v-for="period in incompletePeriods" v-bind:data="period.file" v-bind:file-name="period.fileName"></period-item>
			</div>
			<div v-if="!settingsDirty">
				<input type="file" ref="file" name="file" id="file" accept=".csv" class="file-input" v-on:change="fileNameChange"/><label class="input" for="file">{{fileName || "Choose a file"}}</label>
				<input type="button" class="input" value="submit" v-on:click="postCsv" />
			</div>
			<div class="error" v-if="errorMessage">{{errorMessage}}</div>
		</div>
	</body>
</html>