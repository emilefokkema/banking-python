<html>
	<head>
		<title>Process my banking statements</title>
		<script
		  src="https://code.jquery.com/jquery-3.3.1.min.js"
		  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
		  crossorigin="anonymous"></script>
		<style type="text/css">
			body{
				margin:0px;
				padding: 0px;
			}
			.add{
				margin:10px;
				padding: 10px;
				font-family: monospace;
			}
			.empty{
				padding: 10px;
				color:#ccc;
				font-family: monospace;
				border: 0.5px solid #ccc;
			}
			.period-list{
				margin:10px;
				padding: 10px;
				max-width: 900px;
			}
			.period-list-item{
				padding: 10px;
				font-family: monospace;
				border: 0.5px solid #ccc;
			}
			.category-top{
				display: inline-block;
				width: 40%;
				vertical-align: top;
			}
			.category{
				padding:5px;
				margin: 5px;
			}
			.plus{
				display: none;
			}
			.collapsed > span > .minus{
				display: none;
			}
			.collapsed > span > .plus{
				display: initial;
			}
			.category-set{
				border-left: 0.5px solid #ccc;
			}
			.collapsed > .category-set{
				display: none;
			}
			.collapsed > .row{
				display: none;
			}
			.plus::before{
				content:"+";
				margin-right: 0.5em;
			}
			.minus::before{
				content:"-";
				margin-right: 0.5em;
			}
			.neither::before{
				content:" ";
				margin-right: 1em;
			}
			.row{
				background-color: #efefef;
				padding:5px;
			}
			.toggle-collapse{
				cursor: pointer;
			}
			.more{
				padding:5px;
				color: #bbb;
			}
		</style>
	</head>
	<body>
		<div class="period-list" id="completeList"></div>
		<div class="period-list" id="incompleteList"></div>
		<div class="add">
			
			<input type="file" id="fileInput" accept=".csv" />
			<input type="button" value="submit" id="postButton" />
		
		</div>
		
	<script>
		(function($){
			var dateReviver = function(key, value){
				if(typeof value !== "string"){
					return value;
				}
				var match = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
				if(!match){
					return value;
				}
				return new Date(parseInt(match[1]),parseInt(match[2])-1,parseInt(match[3]));
			};
			var dateString = function(date){
				return date.toLocaleDateString("nl-NL");
			};
			var displayAmount = function(amount){
				var cents = amount % 100;
				var centString = (cents < 10 ? "0" : "")+cents.toString();
				var euroString = Math.floor(amount / 100).toString();
				return "&euro;&nbsp;"+euroString+","+centString;
			};
			var $completeList = $("#completeList").first();
			var $incompleteList = $("#incompleteList").first();

			var makePeriodItem = function(data, $list){
				var $root = $("<div class=\"period-list-item\"><div>van "+dateString(data.from)+" t/m "+dateString(data.through)+(!data.hasEnd ? " (niet compleet)":"")+"</div></div>");
				$root.append(makeCategory("Bij", data.Bij, true))
				$root.append(makeCategory("Af", data.Af, true))
				$list.append($root);
			};

			var makeRow = function(data){
				return $("<div class=\"row\">"+dateString(data.date)+" "+data.description+" "+displayAmount(data.amount)+"</div>")
			}

			var makeCategory = function(name, obj, top){
				var isSimple = typeof obj === typeof 6
				var total = isSimple ? obj : obj.total;
				var $root = $("<div class=\"collapsed category"+(top?" category-top":"")+"\"><span"+(isSimple?"":" class=\"toggle-collapse\"")+">"+(isSimple?"<span class=\"neither\"></span>":"<span class=\"plus\"></span><span class=\"minus\"></span>")+name+": "+displayAmount(total)+"</span></div>");
				$('.toggle-collapse', $root).click(function(){$root.toggleClass("collapsed");})
				if(!isSimple && obj.total !== undefined){
					var $subRoot = $("<div class=\"category-set\"></div>");
					$root.append($subRoot);
					for(var p in obj){
						if(obj.hasOwnProperty(p)){
							if(p == "rows"){
								for(var i=0;i<obj[p].length;i++){
									$subRoot.append(makeRow(obj[p][i]))
								}
								continue;
							}
							if(p == "more"){
								$subRoot.append($("<div class=\"more\">(and "+obj[p]+" more)</div>"));
								continue;
							}
							if(p !== "total"){
								$subRoot.append(makeCategory(p, obj[p]))
							}
						}
					}
				}

				return $root;
			}

			var makePeriodItems = function(list){
				if(list.length == 0){
					$completeList.append($("<div class=\"empty\">no history</div>"));
					return;
				}
				for(var i=0;i<list.length;i++){
					makePeriodItem(list[i].file, $completeList)
				}
			}

			var postCsv = function(){
				var file = document.getElementById("fileInput").files[0];
				var reader = new FileReader();
				reader.onload = function(){
					var data = reader.result;
					$.ajax({
						type:"POST",
						url:"/",
						data:data,
						success:function(d){addIncompletes(d.maanden);refreshList();},
						error:function(e){console.log(e)},
						converters: {"text json":function(s){return JSON.parse(s, dateReviver);}}
					})
				};
				reader.readAsBinaryString(file);
			};

			var addIncompletes = function(data){
				for(var i=0;i<data.length;i++){
					var maand = data[i];
					if(maand.hasBeginning){
						makePeriodItem(maand, $incompleteList)
					}
				}
			}

			var refreshList = function(){
				$completeList.html("")
				$.ajax({
					type: "GET",
					url: "/api/complete",
					success: function(d){makePeriodItems(d)},
					converters: {"text json":function(s){return JSON.parse(s, dateReviver);}}
				});
			};
			
			refreshList();
			$("#postButton").on("click", postCsv);
		})($);
	</script>
	</body>
</html>