<html>
	<head>
		<title>Process my banking statements</title>
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
		<style type="text/css">
			body{
				margin:0px;
				padding: 0px;
			}
			.add{
				margin:10px;
				padding: 10px;
				font-family: monospace;
			}
			.empty{
				padding: 10px;
				color:#ccc;
				font-family: monospace;
				border: 0.5px solid #ccc;
			}
			.period-list{
				margin:10px;
				padding: 10px;
				max-width: 900px;
			}
			.period-list-item{
				padding: 10px;
				font-family: monospace;
				border: 0.5px solid #ccc;
			}
			.category-top{
				display: inline-block;
				width: 40%;
				vertical-align: top;
			}
			.category{
				padding:5px;
				margin: 5px;
			}
			.plus{
				display: none;
			}
			.collapsed > span > .minus{
				display: none;
			}
			.collapsed > span > .plus{
				display: initial;
			}
			.category-set{
				border-left: 0.5px solid #ccc;
			}
			.collapsed > .category-set{
				display: none;
			}
			.collapsed > .row{
				display: none;
			}
			.plus::before{
				content:"+";
				margin-right: 0.5em;
			}
			.minus::before{
				content:"-";
				margin-right: 0.5em;
			}
			.neither::before{
				content:" ";
				margin-right: 1.5em;
			}
			.row{
				background-color: #efefef;
				padding:5px;
			}
			.toggle-collapse{
				cursor: pointer;
			}
			.more{
				padding:5px;
				color: #bbb;
			}
			.amount{
				float: right;
				display: none;
			}
			.collapsed > span > .amount{
				display: initial;
			}
			.row .amount{
				display: initial;
			}
		</style>
	</head>
	<body>
		<script type="text/template" id="categoryTemplate">
			<div class="category" v-bind:class="{collapsed:collapsed,'category-top':top}">
				<span v-bind:class="{'toggle-collapse':!isSimple}" v-on:click="toggleCollapse">
					<span class="neither" v-if="isSimple"></span>
					<template v-else>
						<span class="plus"></span>
						<span class="minus"></span>
					</template>
					{{categoryData.name}}: <amount v-bind:numberOfCents="categoryData.total"></amount>
				</span>
				<div class="category-set" v-if="!isSimple">
					<category v-for="category in categories" v-bind:categoryData="category" v-bind:top="false"></category>
					<row v-for="row in rows" v-bind:row="row"></row>
					<transaction v-for="transaction in transactions" v-bind:transaction="transaction"></transaction>
				</div>
			</div>
		</script>
		<script type="text/template" id="periodItemTemplate">
			<div class="period-list-item">
				<div>van <date v-bind:date="from"></date> t/m <date v-bind:date="through"></date> <span v-if="!hasEnd">(niet compleet)</span></div>
				<category v-bind:top="true" v-bind:categoryData="bij"></category>
				<category v-bind:top="true" v-bind:categoryData="af"></category>
			</div>
		</script>
		<script type="text/template" id="rowTemplate">
			<div class="row" v-bind:title="row.info">
				<date v-bind:date="row.date"></date> {{row.description}} <amount v-bind:numberOfCents="row.amount"></amount>
			</div>
		</script>
		<script type="text/template" id="transactionTemplate">
			<div class="row">
				<date v-bind:date="transaction.date"></date> {{transaction.naam}} {{transaction.omschrijving}} <amount v-bind:numberOfCents="transaction.amount"></amount>
			</div>
		</script>
		<div class="period-list" id="completeList">
			<div class="empty" v-if="periods.length == 0">(no history)</div>
			<period-item v-for="period in periods" v-bind:from="period.from" v-bind:through="period.through" v-bind:has-end="period.hasEnd" v-bind:af="period.Af" v-bind:bij="period.Bij"></period-item>
		</div>
		<div class="period-list" id="incompleteList">
			<period-item v-for="period in periods" v-bind:from="period.from" v-bind:through="period.through" v-bind:has-end="period.hasEnd" v-bind:af="period.Af" v-bind:bij="period.Bij"></period-item>
		</div>
		<div class="add">
			
			<input type="file" id="fileInput" accept=".csv" />
			<input type="button" value="submit" id="postButton" />
		
		</div>
		
	<script>
		(function(){
			
			var amount = {
				props:{
					numberOfCents:Number
				},
				computed:{
					formattedAmount:function(){
						var cents = this.numberOfCents % 100;
						var centString = (cents < 10 ? "0" : "")+cents.toString();
						var euroString = Math.floor(this.numberOfCents / 100).toString();
						return "&euro;&nbsp;"+euroString+","+centString;
					}
				},
				template:'<span class="amount" v-html="formattedAmount"></span>'
			};
			var date = {
				props:{
					date:Date
				},
				computed:{
					formattedDate:function(){return this.date.toLocaleDateString("nl-NL");},
					dayOfWeek:function(){return this.date.toLocaleDateString("nl-NL",{weekday:"long"});}
				},
				template: '<span v-bind:title="dayOfWeek">{{formattedDate}}</span>'
			};
			var category = {
				props:{
					top:Boolean,
					categoryData:Object
				},
				computed:{
					isSimple:function(){return !this.categoryData.categories && !this.categoryData.rows && !this.categoryData.transactions;},
					categories:function(){return this.categoryData.categories || [];},
					transactions:function(){return this.categoryData.transactions || [];},
					rows:function(){return this.categoryData.rows || [];}
				},
				methods:{
					toggleCollapse:function(){this.collapsed = !this.collapsed;}
				},
				data:function(){
					return {collapsed:true};
				},
				template:document.getElementById("categoryTemplate").innerHTML
			};
			category.components = {
				'category': category,
				'row':{
					props:{
						row:Object
					},
					components:{
						'amount':amount,
						'date':date
					},
					template: document.getElementById("rowTemplate").innerHTML
				},
				'transaction':{
					props:{
						transaction:Object
					},
					components:{
						'amount':amount,
						'date':date
					},
					template:document.getElementById("transactionTemplate").innerHTML
				},
				'amount':amount
			};
			var components = {
				'period-item' : {
					props:{
						hasEnd:Boolean,
						from:Date,
						through:Date,
						af:Object,
						bij:Object
					},
					components:{
						'category':category,
						'date':date
					},
					template:document.getElementById("periodItemTemplate").innerHTML
				}
			};
			
			var completeList = new Vue({
				el:"#completeList",
				data:{
					periods:[]
				},
				components:components
			});

			var incompleteList = new Vue({
				el:"#incompleteList",
				data:{
					periods:[]
				},
				components:components
			});

			var dateReviver = function(key, value){
				if(typeof value !== "string"){
					return value;
				}
				var match = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
				if(!match){
					return value;
				}
				return new Date(parseInt(match[1]),parseInt(match[2])-1,parseInt(match[3]));
			};

			var postCsv = function(){
				var file = document.getElementById("fileInput").files[0];
				var reader = new FileReader();
				reader.onload = function(){
					var data = reader.result;
					var req = new XMLHttpRequest();
					req.addEventListener("load",function(){
						var responseData = JSON.parse(this.responseText, dateReviver);
						incompleteList.periods = responseData.maanden.filter(function(m){return m.hasBeginning;});
						refreshList();
					});
					req.open("POST","/");
					req.send(data);
				};
				reader.readAsBinaryString(file);
			};

			var refreshList = function(){
				var req = new XMLHttpRequest();
				req.addEventListener("load",function(){
					var data = JSON.parse(this.responseText, dateReviver);
					completeList.periods = data.map(function(o){return o.file;});
				});
				req.open("GET","/api/complete");
				req.send();
			};
			
			refreshList();
			document.getElementById("postButton").addEventListener("click",postCsv);
		})();
	</script>
	</body>
</html>